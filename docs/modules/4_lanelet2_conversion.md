# Module — Lanelet2 Conversion

## Purpose

Converts the **GraphMap** generated in the previous step into a **Lanelet2-compliant map**, ready for use in any system or tool that supports Lanelet2.
The module detects lanes and markings from graph data, converts them into Lanelet2 objects (points, linestrings, lanelets), and exports the results as `.osm` and `.json` files.

---

## Input  
These are the concrete data resources required by this module.  
Other options (lane size limits, ignored classes, zone, etc.) are read from the JSON configuration file and are documented in the **Parameters** section.

| Type | Description |
|------|-------------|
| **JSON configuration** | JSON file containing the `lanelet2` section. It defines where to read the GraphMap from, where to write the Lanelet2 map, which UTM zone to use, tuning parameters for lane extraction, and optional paths for annotated outputs. |
| **GraphMap folder** | Directory produced by Module 3 that contains the processed graph data (nodes, edges, shapes) representing road markings and lane structures. This is the main input that will be converted into Lanelet2 linestrings and lanelets. |

---

## Processing
1. Loads configuration and validates input/output paths.  
2. Loads `GraphMap` generated by the previous module.  
3. Uses **LaneFinder** and **LinesSplitPropagator** to identify potential lanes based on class and geometry.  
4. Converts valid lines and shapes to **Lanelet2 Linestrings** and **Lanelets**, assigning class-specific attributes.  
5. Projects map coordinates to **UTM** (or optionally WGS84) using the specified zone.  
6. Exports the resulting map as:
   - `lanelet2_map.osm` — full HD map in Lanelet2 format  
   - `lanelet2_map.osminfo.json` — metadata (projection info, origin, etc.)  
7. Optionally exports annotated intermediate graphs for debugging or visualization.

---

## Output

| File                          | Description                                           | Example Path                                       |
| ----------------------------- | ----------------------------------------------------- | -------------------------------------------------- |
| `lanelet2_map.osm`            | Lanelet2-compliant map with road geometries and lanes | `/app/output/lanenet_output/lanelet2_map.osm`      |
| `lanelet2_mapinfo.json`       | Metadata describing projection, origin, and UTM zone  | `/app/output/lanenet_output/lanelet2_mapinfo.json` |
| *(optional)* Annotated graphs | Graphs tagged with lane and class information         | `/app/output/lanenet_output/annotated_graphs/`     |

---

## Parameters

| Parameter | Description | Default / Example | Required |
|------------|-------------|-------------------|-----------|
| `lanelet2.input_path` | Path to input GraphMap directory | `/app/output/GraphMap` | Mandatory |
| `lanelet2.output_file` | Output path for the resulting Lanelet2 `.osm` file | `/app/output/lanelet2_map.osm` | Mandatory |
| `lanelet2.annotated_map_path` | Optional directory for saving annotated graphs (with lane information) | `/app/output/lanenet_output/` | Optional |
| `lanelet2.zone_number` | UTM zone number used for coordinate projection | `33` | Mandatory |
| `lanelet2.zone_letter` | UTM zone letter | `"N"` | Mandatory |
| `lanelet2.car_height` | Average sensor height from the ground in meters | `0.0` | Optional |
| `lanelet2.min_lane_size` | Minimum lane width in meters | `1.5` | Optional |
| `lanelet2.max_lane_size` | Maximum lane width in meters | `6.0` | Optional |
| `lanelet2.search_tolerance` | Search radius for lane connections in meters | `0.5` | Optional |
| `lanelet2.ignore_classes` | List of graph classes to ignore during conversion | `[9, 10, 13, 14]` | Optional |
| `lanelet2.max_corner_angle` | Maximum corner angle (degrees) when connecting lanes | `60` | Optional |

---

## Run Command
```bash
docker run --rm \
  -v /path/to/config_file:/home/developer/material/config \
  -v /path/to/graphmap:/home/developer/material/GraphMap \
  -v /path/to/output:/home/developer/material/lanenet_output \
  4_lanelet2_conversion \
  script/graph2let.py -i /home/developer/material/config/convert_graph_to_lanelet2.config.json
